<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chatik test</title>
</head>
<body>

<button id="login">Войти</button>
<button id="logout">Выйти</button>

<h3>Конфы</h3>
<div id="confs"></div>

<input id="confName" placeholder="название">
<button id="create">Создать конфу</button>

<hr>

<div id="chat"></div>
<input id="msg">
<button id="send">Отправить</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyDwZNhLW89Iw_vPpTovJLphGlJ112prEZk",
  authDomain: "chatik-598fd.firebaseapp.com",
  databaseURL: "https://chatik-598fd-default-rtdb.firebaseio.com",
  projectId: "chatik-598fd"
});

const auth = getAuth();
const db = getDatabase();
const provider = new GoogleAuthProvider();

let user = null;
let currentConf = null;

login.onclick = () => signInWithPopup(auth, provider);
logout.onclick = () => signOut(auth);

onAuthStateChanged(auth, u => {
  user = u;
  if (!u) return;
  loadConfs();
});

function loadConfs() {
  onValue(ref(db,"confs"), s => {
    confs.innerHTML = "";
    s.forEach(c => {
      const d = document.createElement("div");
      d.textContent = c.val().name;
      d.onclick = () => openConf(c.key);
      confs.append(d);
    });
  });
}

create.onclick = () => {
  if (!user) return alert("не вошёл");
  push(ref(db,"confs"), {
    name: confName.value,
    owner: user.uid
  });
};

function openConf(id) {
  currentConf = id;
  onValue(ref(db,"confs/"+id+"/messages"), s => {
    chat.innerHTML = "";
    s.forEach(m => {
      const d = document.createElement("div");
      d.textContent = m.val().text;
      chat.append(d);
    });
  });
}

send.onclick = () => {
  if (!currentConf) return;
  push(ref(db,"confs/"+currentConf+"/messages"), {
    text: msg.value
  });
  msg.value = "";
};
</script>
</body>
</html>
